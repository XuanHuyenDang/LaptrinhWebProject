<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>L·ªãch s·ª≠ ƒë∆°n h√†ng - Florio Flower Shop</title>

  <meta name="_csrf" th:if="${_csrf}" th:content="${_csrf.token}">
  <meta name="_csrf_header" th:if="${_csrf}" th:content="${_csrf.headerName}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <link rel="stylesheet" th:href="@{/assets/css/header.css}">
  <link rel="stylesheet" th:href="@{/assets/css/footer.css}">

  <link rel="stylesheet" th:href="@{/assets/css/order-list.css}">

  <style>
    .order-card.hidden-page {
        display: none;
    }
    .pagination .page-item .page-link {
        cursor: pointer; /* Indicate clickable links */
    }

    /* Th√™m style cho c√°c tr·∫°ng th√°i m·ªõi */
    .badge-status.st-return {
        background-color: var(--bs-warning-bg-subtle);
        color: var(--bs-warning-text-emphasis);
        border: 1px solid var(--bs-warning-border-subtle);
    }
    .badge-status.st-return-done {
        background-color: var(--bs-gray-300);
        color: var(--bs-gray-700);
        border: 1px solid var(--bs-gray-400);
    }
    .badge-status.st-return-fail {
        background-color: var(--bs-danger-bg-subtle);
        color: var(--bs-danger-text-emphasis);
        border: 1px solid var(--bs-danger-border-subtle);
    }
    /* Th√™m style cho tr·∫°ng th√°i ch·ªù thanh to√°n */
    .badge-status.st-pending-payment {
        background-color: var(--bs-secondary-bg-subtle);
        color: var(--bs-secondary-text-emphasis);
        border: 1px solid var(--bs-secondary-border-subtle);
    }

    /* === STYLE CHO FORM H·ª¶Y ƒê∆†N === */
    /* ƒê·∫£m b·∫£o form kh√¥ng l√†m v·ª° layout */
    form[method="post"] {
        display: inline;
    }
    /* ============================ */
    /* Style cho tag ph·ª• */
    .badge-sub-status {
        font-size: 0.75em; /* Nh·ªè h∆°n badge ch√≠nh */
        padding: 0.25em 0.5em;
    }
  </style>
</head>
<body>

<div th:replace="~{fragments/navbar :: navbar}"></div>

<main class="container-narrow my-4">
  <div class="page-title">
    <div class="icon"><i class="bi bi-receipt-cutoff"></i></div>
    <div>
      <h4 class="mb-0">L·ªãch s·ª≠ ƒë∆°n h√†ng</h4>
      <small class="text-muted"
             th:if="${orders != null}"
             th:text="'B·∫°n c√≥ ' + ${#lists.size(orders)} + ' ƒë∆°n h√†ng'">B·∫°n c√≥ 0 ƒë∆°n h√†ng</small>
    </div>
  </div>

  <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
  <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>
  <div class="empty" th:if="${orders == null or #lists.isEmpty(orders)}">
       <div style="font-size: 3rem; margin-bottom: 1rem;">üõçÔ∏è</div>
       <div class="fs-5 mb-3">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o ƒë∆∞·ª£c ghi nh·∫≠n.</div>
       <a class="btn btn-outline-primary" th:href="@{/}">
         <i class="bi bi-house-door"></i> Quay v·ªÅ trang ch·ªß
       </a>
  </div>

  <div id="orderListContainer" class="vstack gap-0" th:if="${orders != null and !#lists.isEmpty(orders)}">
      <div class="order-card" th:each="o, iterStat : ${orders}" th:attr="data-page=${iterStat.index / 6}">
          <div class="order-head">
              <div>
                  <div class="order-id">ƒê∆°n #<span th:text="${o.id}">0</span></div>
                  <div class="order-date">
                      <i class="bi bi-calendar3 me-1"></i>
                      <span th:text="${o.orderDate != null ? #temporals.format(o.orderDate,'dd/MM/yyyy HH:mm') : '‚Äî'}">‚Äî</span>
                  </div>
              </div>
              <div class="text-end"
                   th:with="
                       st=${o.status != null ? o.status : 'ƒêang x·ª≠ l√Ω'},
                       stClass=${
                           #strings.equalsIgnoreCase(st,'ƒêang x·ª≠ l√Ω') ? ' st-processing' :
                           #strings.equalsIgnoreCase(st,'ƒêang giao')   ? ' st-shipping'  :
                           #strings.equalsIgnoreCase(st,'Ho√†n t·∫•t')    ? ' st-complete'  :
                           #strings.equalsIgnoreCase(st,'ƒê√£ h·ªßy')      ? ' st-cancel'    :
                           #strings.equalsIgnoreCase(st,'Y√™u c·∫ßu tr·∫£ h√†ng') ? ' st-return' :
                           #strings.equalsIgnoreCase(st,'ƒê√£ tr·∫£ h√†ng') ? ' st-return-done' :
                           #strings.equalsIgnoreCase(st,'ƒê√£ t·ª´ ch·ªëi tr·∫£ h√†ng') ? ' st-return-fail' :
                           #strings.equalsIgnoreCase(st,'Ch·ªù thanh to√°n') ? ' st-pending-payment' :
                           ' st-processing'
                       }">
                  <div class="order-total mb-1">
                      <span class="soft">T·ªïng:</span>
                      <span class="sum"
                            th:text="${#numbers.formatDecimal(o.totalAmount!=null?o.totalAmount:T(java.math.BigDecimal).ZERO,0,'COMMA',0,'POINT')} + 'ƒë'">0ƒë</span>
                  </div>
                  <div>
                      <span class="badge-status" th:classappend="${stClass}" th:text="${st}">ƒêang x·ª≠ l√Ω</span>
                      <span th:if="${#strings.equalsIgnoreCase(o.paymentMethod, 'VNPAY') and o.status != 'Ch·ªù thanh to√°n' and o.status != 'ƒê√£ h·ªßy'}"
                            class="badge bg-success text-white ms-1 badge-sub-status">
                          <i class="bi bi-check-circle-fill"></i> ƒê√£ thanh to√°n
                      </span>
                      <span th:if="${#strings.equalsIgnoreCase(o.paymentMethod, 'VNPAY') and o.status == 'Ch·ªù thanh to√°n'}"
                            class="badge bg-warning text-dark ms-1 badge-sub-status">
                           <i class="bi bi-hourglass-split"></i> Ch∆∞a thanh to√°n
                      </span>
                      </div>
              </div>
          </div>
          <div class="order-body">
              <div class="row g-3 align-items-center">
                  <div class="col-md-7">
                      <div class="order-meta">
                          <div><i class="bi bi-person me-2"></i> <strong th:text="${o.recipientName}">Kh√°ch h√†ng</strong> ‚Ä¢ <span th:text="${o.recipientPhone}">0</span></div>
                          <div class="text-truncate"><i class="bi bi-geo-alt me-2"></i> <span th:text="${o.shippingAddress}">ƒê·ªãa ch·ªâ</span></div>
                          <div th:if="${o.paymentMethod != null}"><i class="bi bi-credit-card me-2"></i> <span th:text="${o.paymentMethod == 'BANK' ? 'Chuy·ªÉn kho·∫£n' : (o.paymentMethod == 'VNPAY' ? 'VNPAY' : 'COD')}">COD</span></div>
                      </div>
                  </div>

                  <div class="col-md-5 d-flex justify-content-md-end gap-2 flex-wrap"> <a class="btn btn-primary btn-sm" th:href="@{|/orders/${o.id}|}"><i class="bi bi-search"></i> Chi ti·∫øt</a>

                      <a th:if="${o.status == 'Ch·ªù thanh to√°n' and #strings.equalsIgnoreCase(o.paymentMethod, 'VNPAY') and vnpayUrls.containsKey(o.id)}"
                         th:href="${vnpayUrls.get(o.id)}"
                         class="btn btn-warning btn-sm fw-bold">
                          <i class="bi bi-credit-card-2-front"></i> Thanh to√°n ngay
                      </a>
                      <span th:if="${o.status == 'Ch·ªù thanh to√°n' and #strings.equalsIgnoreCase(o.paymentMethod, 'VNPAY') and !vnpayUrls.containsKey(o.id)}"
                            class="badge bg-danger text-white py-2">L·ªói t·∫°o link TT</span>

                      <form th:if="${o.status == 'ƒêang x·ª≠ l√Ω' or o.status == 'Ch·ªù thanh to√°n'}"
                            th:action="@{/orders/cancel/{id}(id=${o.id})}"
                            method="post"
                            onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy ƒë∆°n h√†ng #' + [[${o.id}]] + ' kh√¥ng?');">

                          <input type="hidden" th:if="${_csrf}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                          <button type="submit" class="btn btn-danger btn-sm">
                              <i class="bi bi-x-circle"></i> H·ªßy ƒë∆°n
                          </button>
                      </form>

                      <a th:if="${o.status == 'Ho√†n t·∫•t'
                                 and o.completedDate != null
                                 and now != null and now.isBefore(o.completedDate.plusDays(7))
                                 and o.returnRequest == null}"
                         th:href="@{/orders/return/{id}(id=${o.id})}"
                         class="btn btn-outline-danger btn-sm">
                          <i class="bi bi-arrow-return-left"></i> Y√™u c·∫ßu tr·∫£ h√†ng
                      </a>

                      <span th:if="${o.status == 'ƒê√£ t·ª´ ch·ªëi tr·∫£ h√†ng'}"
                         class="btn btn-sm btn-danger disabled" style="opacity: 0.7;">
                          ƒê√£ t·ª´ ch·ªëi
                      </span>
                  </div>
              </div>
              <div class="accordion accordion-flush mt-3" th:if="${o.details != null and !#lists.isEmpty(o.details)}" th:id="${'acc-'+o.id}">
                  <div class="accordion-item">
                      <h2 class="accordion-header" th:id="${'h-'+o.id}">
                          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" th:data-bs-target="${'#c-'+o.id}" aria-expanded="false" th:aria-controls="${'c-'+o.id}">
                              <i class="bi bi-list-ul me-2"></i> Xem s·∫£n ph·∫©m trong ƒë∆°n
                          </button>
                      </h2>
                      <div class="accordion-collapse collapse" th:id="${'c-'+o.id}" th:aria-labelledby="${'h-'+o.id}" th:data-bs-parent="${'#acc-'+o.id}">
                          <div class="accordion-body">
                              <div class="table-responsive">
                                  <table class="table table-sm align-middle mb-0">
                                      <thead class="table-light">
                                          <tr><th>S·∫£n ph·∫©m</th><th class="text-center">SL</th><th class="text-end">ƒê∆°n gi√°</th><th class="text-end">Th√†nh ti·ªÅn</th></tr>
                                      </thead>
                                      <tbody>
                                          <tr th:each="d : ${o.details}" th:with="q=${d.quantity != null ? d.quantity.longValue() : 0L}">
                                              <td th:text="${d.product != null ? d.product.productName : 'S·∫£n ph·∫©m'}"></td>
                                              <td class="text-center" th:text="${d.quantity}"></td>
                                              <td class="text-end" th:text="${#numbers.formatDecimal(d.price,0,'COMMA',0,'POINT')} + 'ƒë'"></td>
                                              <td class="text-end fw-semibold" th:text="${#numbers.formatDecimal((d.price != null) ? d.price.multiply(T(java.math.BigDecimal).valueOf(q)) : T(java.math.BigDecimal).ZERO, 0, 'COMMA', 0, 'POINT')} + 'ƒë'"></td>
                                          </tr>
                                      </tbody>
                                  </table>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
          </div>
      </div>
  </div>

 <nav id="paginationNav" aria-label="Order history pagination" class="mt-4 d-none" th:if="${orders != null and #lists.size(orders) > 6}">
      <ul class="pagination justify-content-center">
          <li class="page-item" id="prevPage">
              <a class="page-link" href="#" aria-label="Previous">
                  <span aria-hidden="true">&laquo;</span>
              </a>
          </li>
          <li class="page-item page-number-template d-none"><a class="page-link" href="#">1</a></li>
          <li class="page-item" id="nextPage">
              <a class="page-link" href="#" aria-label="Next">
                  <span aria-hidden="true">&raquo;</span>
              </a>
          </li>
      </ul>
  </nav>
  <div class="mt-4 text-center">
    <a class="btn btn-outline-secondary" th:href="@{/}">
      <i class="bi bi-chevron-left"></i> Quay v·ªÅ trang ch·ªß
    </a>
  </div>
</main>

<div th:replace="~{fragments/footer :: footer}"></div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script th:inline="javascript">
    // --- PH·∫¶N SCRIPT PH√ÇN TRANG GI·ªÆ NGUY√äN ---
    document.addEventListener('DOMContentLoaded', () => {
        const ordersPerPage = 6;
        const orderCards = document.querySelectorAll('#orderListContainer .order-card');
        const paginationNav = document.getElementById('paginationNav');
        const prevPageLink = document.getElementById('prevPage');
        const nextPageLink = document.getElementById('nextPage');
        const pageNumberTemplate = document.querySelector('.page-number-template');

        if (!orderCards.length || orderCards.length <= ordersPerPage) {
             if(paginationNav) paginationNav.classList.add('d-none');
             orderCards.forEach(card => card.classList.remove('hidden-page'));
            return;
        }

        const totalOrders = orderCards.length;
        const totalPages = Math.ceil(totalOrders / ordersPerPage);
        let currentPage = 0; // 0-based index

        function showPage(pageIndex) {
            currentPage = pageIndex;
            orderCards.forEach((card, index) => {
                const cardPage = parseInt(card.getAttribute('data-page'));
                if (cardPage === currentPage) {
                    card.classList.remove('hidden-page');
                } else {
                    card.classList.add('hidden-page');
                }
            });
            updatePaginationControls();
        }

        function updatePaginationControls() {
            const existingPageLinks = paginationNav.querySelectorAll('.page-item:not(#prevPage):not(#nextPage):not(.page-number-template)');
            existingPageLinks.forEach(link => link.remove());

            for (let i = 0; i < totalPages; i++) {
                const pageLinkItem = pageNumberTemplate.cloneNode(true);
                pageLinkItem.classList.remove('page-number-template', 'd-none');
                const link = pageLinkItem.querySelector('a');
                link.textContent = i + 1;
                link.setAttribute('data-page', i);
                if (i === currentPage) {
                    pageLinkItem.classList.add('active');
                    link.setAttribute('aria-current', 'page');
                } else {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        showPage(i);
                    });
                }
                nextPageLink.parentNode.insertBefore(pageLinkItem, nextPageLink);
            }

            prevPageLink.classList.toggle('disabled', currentPage === 0);
            nextPageLink.classList.toggle('disabled', currentPage === totalPages - 1);
        }

        prevPageLink.addEventListener('click', (e) => {
            e.preventDefault();
            if (currentPage > 0) {
                showPage(currentPage - 1);
            }
        });

        nextPageLink.addEventListener('click', (e) => {
            e.preventDefault();
            if (currentPage < totalPages - 1) {
                showPage(currentPage + 1);
            }
        });

        paginationNav.classList.remove('d-none');
        showPage(0);

    });
</script>
</body>
</html>