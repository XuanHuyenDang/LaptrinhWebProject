<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Chat v·ªõi c·ª≠a h√†ng - Florio Flower Shop</title>
    
    <th:block th:if="${_csrf}">
      <meta name="_csrf" th:content="${_csrf.token}">
      <meta name="_csrf_header" th:content="${_csrf.headerName}">
    </th:block>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/assets/css/header.css}">
    <link rel="stylesheet" th:href="@{/assets/css/footer.css}">
    
    <style>
        body { background-color: #f8f9fa; }
        /* Layout for Customer (Simple Container) */
        .chat-container-customer {
             max-width: 800px; margin: 2rem auto; background: white;
             border-radius: 1rem; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
             height: calc(100vh - 12rem); /* Adjusted height considering navbar/footer */
             max-height: 600px;
             display: flex; flex-direction: column;
        }
        .chat-header { padding: 1rem 1.5rem; border-bottom: 1px solid #e9ecef; display: flex; align-items: center; }
        .chat-header h5 { color: #d63384; font-weight: 600; }
        .chat-messages {
            flex-grow: 1; padding: 1.5rem; overflow-y: auto;
            display: flex; flex-direction: column; gap: 0.75rem;
        }
        .chat-message {
            padding: 0.6rem 1rem; border-radius: 1.2rem;
            max-width: 75%; line-height: 1.5; word-wrap: break-word;
        }
        .chat-message.sender { background-color: #d63384; color: white; align-self: flex-end; border-bottom-right-radius: 0.3rem; }
        .chat-message.receiver { background-color: #e9ecef; color: #212529; align-self: flex-start; border-bottom-left-radius: 0.3rem; }
        .chat-message.system { align-self: center; font-size: 0.8rem; color: #6c757d; }
        .message-sender { font-weight: bold; font-size: 0.8rem; margin-bottom: 0.2rem; }
        .chat-input { padding: 1rem 1.5rem; border-top: 1px solid #e9ecef; }
        /* Login prompt styles */
        #login-required { max-width: 400px; margin-top: 10rem; }
    </style>
</head>
<body>

<div th:replace="~{fragments/navbar :: navbar}"></div>

<div id="login-required" class="container text-center" sec:authorize="isAnonymous()">
    <div class="card p-4 shadow-sm">
        <h3 class="mb-3">üîí Y√™u c·∫ßu ƒëƒÉng nh·∫≠p</h3>
        <p>B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng ch·ª©c nƒÉng chat.</p>
        <a th:href="@{/auth/login(redirect=${#request.requestURI})}" class="btn btn-primary w-100 mt-2">
            ƒêi ƒë·∫øn trang ƒëƒÉng nh·∫≠p
        </a>
    </div>
</div>

<div id="chat-page-customer" sec:authorize="hasRole('CUSTOMER')">
    <div class="chat-container-customer">
        <div class="chat-header">
            <h5 class="mb-0">üí¨ Chat v·ªõi Florio</h5>
        </div>
        <div class="chat-messages" id="messageAreaCustomer"></div>
        <div class="chat-input">
            <form id="messageFormCustomer" name="messageFormCustomer">
                <div class="input-group">
                    <input type="text" id="messageCustomer" placeholder="Nh·∫≠p tin nh·∫Øn..." class="form-control" autocomplete="off" required>
                    <button class="btn btn-primary" type="submit">G·ª≠i</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script th:inline="javascript" sec:authorize="hasRole('CUSTOMER')">
    'use strict';
    // === CUSTOMER SCRIPT (Gi·ªØ nguy√™n nh∆∞ tr∆∞·ªõc) ===
    const USER_EMAIL = /*[[${#authentication.name}]]*/ null;
    const IS_ADMIN = false; // Hardcoded for this template
    const ADMIN_USERNAME = 'admin@flowershop.com'; 
    const API_BASE_URL = /*[[@{/api/chat}]]*/ '/api/chat';
    const csrfHeaderName = document.querySelector('meta[name="_csrf_header"]')?.content;
    const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
    const FETCH_HEADERS = { 'Content-Type': 'application/json' };
    if (csrfHeaderName && csrfToken) { FETCH_HEADERS[csrfHeaderName] = csrfToken; }

    let stompClient = null;
    const messageArea = document.querySelector('#messageAreaCustomer');
    const messageForm = document.querySelector('#messageFormCustomer');
    const messageInput = document.querySelector('#messageCustomer');

    // ... (To√†n b·ªô c√°c h√†m JavaScript connect, onConnected, onError, loadChatHistory, sendMessage, onMessageReceived, appendMessage gi·ªØ nguy√™n nh∆∞ phi√™n b·∫£n tr∆∞·ªõc d√†nh cho Customer) ...
     function connect() { 
        if (!USER_EMAIL) return;
        const socket = new SockJS('/ws'); 
        stompClient = Stomp.over(socket);
        stompClient.connect({}, onConnected, onError);
    }

    async function onConnected() { 
        stompClient.subscribe('/user/queue/private', onMessageReceived);
        await loadChatHistory(ADMIN_USERNAME); // T·∫£i l·ªãch s·ª≠ v·ªõi Admin
    }

     function onError(error) { 
        console.error("L·ªói WebSocket:", error);
        appendMessage(null, 'H·ªá th·ªëng', 'M·∫•t k·∫øt n·ªëi. Vui l√≤ng t·∫£i l·∫°i trang.', 'system');
     }

    async function loadChatHistory(partnerEmail) { 
         const url = `${API_BASE_URL}/history`; // Customer ch·ªâ t·∫£i c·ªßa Admin
         try {
            const response = await fetch(url, { headers: FETCH_HEADERS });
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`L·ªói t·∫£i l·ªãch s·ª≠ (${response.status}): ${errorText || response.statusText}`);
            }
            const history = await response.json(); 
            messageArea.innerHTML = ''; 
            history.forEach(msg => {
                appendMessage(msg.sender, msg.sender, msg.content, null);
            });
            messageArea.scrollTop = messageArea.scrollHeight; 
        } catch (err) {
            console.error(err);
            messageArea.innerHTML = ''; 
            appendMessage(null, 'H·ªá th·ªëng', `L·ªói: ${err.message}`, 'system');
        }
    }

    function sendMessage(event) { 
        event.preventDefault();
        const messageContent = messageInput.value.trim();
        if (messageContent && stompClient) {
            const chatMessage = {
                sender: USER_EMAIL, recipient: ADMIN_USERNAME, // Always send to admin
                content: messageContent, type: 'CHAT'
            };
            stompClient.send("/app/chat.private", {}, JSON.stringify(chatMessage));
            messageInput.value = '';
        }
    }

    function onMessageReceived(payload) { 
        const message = JSON.parse(payload.body); 
        if (message.sender === USER_EMAIL || message.sender === ADMIN_USERNAME) {
             appendMessage(message.sender, message.sender, message.content, null);
        }
    }
    
    function appendMessage(senderEmail, senderDisplay, content, type) { 
        const messageElement = document.createElement('div');
        messageElement.classList.add('chat-message');
        if(type === 'system') {
            messageElement.classList.add('system');
            messageElement.textContent = content;
        } else {
            if (senderEmail === USER_EMAIL) messageElement.classList.add('sender');
            else messageElement.classList.add('receiver');
            
            const senderElement = document.createElement('div');
            senderElement.classList.add('message-sender');
            let displayName = (senderEmail === ADMIN_USERNAME) ? 'Admin' : senderEmail; 
            if (senderEmail === USER_EMAIL) displayName = 'B·∫°n';
            senderElement.textContent = displayName;

            const contentElement = document.createElement('div');
            contentElement.textContent = content; 
            messageElement.appendChild(senderElement);
            messageElement.appendChild(contentElement);
        }
        messageArea.appendChild(messageElement);
        const isScrolledToBottom = messageArea.scrollHeight - messageArea.clientHeight <= messageArea.scrollTop + 1;
        if (type==='system' || senderEmail === USER_EMAIL || isScrolledToBottom) {
             messageArea.scrollTop = messageArea.scrollHeight;
        }
    }

    messageForm.addEventListener('submit', sendMessage, true);
    connect(); 
</script>

<div th:replace="~{fragments/footer :: footer}"></div>

</body>
</html>