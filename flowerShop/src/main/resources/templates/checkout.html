<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thanh to√°n ƒë∆°n h√†ng - Florio Flower Shop</title>

  <!-- CSRF (render khi b·∫≠t Spring Security CSRF) -->
  <th:block th:if="${_csrf}">
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
  </th:block>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; }
    .checkout-container {
      max-width: 950px;
      margin: 50px auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      padding: 30px;
    }
    .section-title {
      font-weight: 600;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 8px;
      margin-bottom: 20px;
    }
    .payment-option {
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 15px;
      transition: 0.2s;
      cursor: pointer;
    }
    .payment-option:hover { border-color: #dc3545; background: #fff6f6; }
    .payment-option input { margin-right: 10px; }
    .bank-info {
      background-color: #f8f9fa;
      border: 1px dashed #aaa;
      padding: 10px 15px;
      border-radius: 8px;
      display: none;
      font-size: 0.95rem;
    }
    #global-toast { position: fixed; right: 16px; bottom: 16px; z-index: 1080; }
  </style>
</head>
<body>

  <!-- Header (n·∫øu d√πng Thymeleaf fragment) -->
  <div th:replace="~{fragments/navbar :: navbar}"></div>

  <div class="checkout-container">
    <h3 class="text-center text-danger mb-4"><i class="bi bi-credit-card"></i> Thanh to√°n ƒë∆°n h√†ng</h3>

    <!-- Th√¥ng b√°o -->
    <div id="global-toast"></div>

    <!-- Th√¥ng tin giao h√†ng -->
    <div class="mb-4">
      <h5 class="section-title"><i class="bi bi-truck"></i> Th√¥ng tin giao h√†ng</h5>
      <form id="checkoutForm">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">H·ªç v√† t√™n *</label>
            <input type="text" class="form-control" id="name" autocomplete="name" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">S·ªë ƒëi·ªán tho·∫°i *</label>
            <input type="tel" class="form-control" id="phone" autocomplete="tel" required>
          </div>
          <div class="col-md-12">
            <label class="form-label">ƒê·ªãa ch·ªâ giao h√†ng *</label>
            <input type="text" class="form-control" id="address" autocomplete="street-address" required>
          </div>
          <div class="col-md-12">
            <label class="form-label">Ghi ch√∫ (n·∫øu c√≥)</label>
            <textarea class="form-control" rows="2" id="note" placeholder="V√≠ d·ª•: Giao bu·ªïi s√°ng, k√®m thi·ªáp ch√∫c m·ª´ng..."></textarea>
          </div>
        </div>
      </form>
    </div>

    <!-- T√≥m t·∫Øt ƒë∆°n h√†ng -->
    <div class="mb-4">
      <h5 class="section-title"><i class="bi bi-receipt"></i> T√≥m t·∫Øt ƒë∆°n h√†ng</h5>

      <div id="cart-loading" class="text-center py-3">
        <div class="spinner-border text-danger" role="status" aria-hidden="true"></div>
        <div class="mt-2 text-muted">ƒêang t·∫£i gi·ªè h√†ng...</div>
      </div>

      <div id="cart-empty" class="alert alert-warning d-none">
        Gi·ªè h√†ng ƒëang tr·ªëng. <a th:href="@{/products}" href="/products" class="alert-link">Ti·∫øp t·ª•c mua s·∫Øm</a>.
      </div>

      <div id="cart-error" class="alert alert-danger d-none"></div>

      <div id="order-summary-wrap" class="d-none">
        <div class="table-responsive">
          <table class="table table-bordered align-middle text-center">
            <thead class="table-light">
              <tr>
                <th style="min-width: 240px;">S·∫£n ph·∫©m</th>
                <th style="width: 110px;">S·ªë l∆∞·ª£ng</th>
                <th style="width: 160px;">ƒê∆°n gi√°</th>
                <th style="width: 180px;">T·ªïng</th>
              </tr>
            </thead>
            <tbody id="order-lines"></tbody>
            <tfoot class="table-light">
              <tr>
                <td colspan="3" class="text-end fw-semibold">T·∫°m t√≠nh:</td>
                <td id="sum-subtotal" class="fw-semibold text-end">0‚Ç´</td>
              </tr>
              <tr>
                <td colspan="3" class="text-end fw-semibold">Ph√≠ v·∫≠n chuy·ªÉn:</td>
                <td id="sum-shipping" class="fw-semibold text-end">0‚Ç´</td>
              </tr>
              <tr>
                <td colspan="3" class="text-end fw-bold">T·ªïng c·ªông:</td>
                <td id="sum-total" class="fw-bold text-danger text-end">0‚Ç´</td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>

    <!-- H√¨nh th·ª©c thanh to√°n -->
    <div class="mb-4">
      <h5 class="section-title"><i class="bi bi-cash-coin"></i> H√¨nh th·ª©c thanh to√°n</h5>
      <div class="payment-option mb-2">
        <input type="radio" name="payment" id="cod" value="COD" checked>
        <label for="cod" class="mb-0 fw-semibold">üíµ Thanh to√°n khi nh·∫≠n h√†ng (COD)</label>
        <p class="mb-0 text-muted ms-4">Qu√Ω kh√°ch thanh to√°n b·∫±ng ti·ªÅn m·∫∑t khi nh·∫≠n h√†ng.</p>
      </div>

      <div class="payment-option">
        <input type="radio" name="payment" id="bank" value="BANK">
        <label for="bank" class="mb-0 fw-semibold">üí≥ Chuy·ªÉn kho·∫£n ng√¢n h√†ng</label>
        <p class="mb-0 text-muted ms-4">Qu√Ω kh√°ch chuy·ªÉn kho·∫£n theo th√¥ng tin b√™n d∆∞·ªõi.</p>
        <div class="bank-info mt-2 ms-4" id="bankInfo">
          <strong>Ng√¢n h√†ng:</strong> Vietcombank<br>
          <strong>S·ªë t√†i kho·∫£n:</strong> 0123456789<br>
          <strong>Ch·ªß t√†i kho·∫£n:</strong> Florio Flower Shop<br>
          <strong>N·ªôi dung:</strong> [T√™n kh√°ch h√†ng] - [SƒêT] - Thanh to√°n ƒë∆°n h√†ng
        </div>
      </div>
    </div>

    <!-- N√∫t ƒë·∫∑t h√†ng -->
    <div class="text-center">
      <button id="confirmBtn" class="btn btn-danger px-5 py-2 fw-semibold" disabled>
        <span class="btn-text"><i class="bi bi-bag-check"></i> X√°c nh·∫≠n ƒë·∫∑t h√†ng</span>
        <span class="btn-spin d-none spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
      </button>
    </div>
  </div>

  <!-- Footer -->
  <div th:replace="~{fragments/footer :: footer}"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ===== Helpers =====
    const API_BASE = (window.CART_CFG && window.CART_CFG.API_BASE) || '/api/cart';
    const fmtVND = n => new Intl.NumberFormat('vi-VN', { style:'currency', currency:'VND', maximumFractionDigits:0 }).format(n ?? 0);

    function buildCsrfHeaders() {
      const headers = {};
      const token = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
      const headerName = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');
      if (token && headerName) headers[headerName] = token;
      return headers;
    }
    function buildJsonHeaders() { return { 'Content-Type':'application/json', ...buildCsrfHeaders() }; }

    async function fetchJson(url, options = {}) {
      const res = await fetch(url, options);
      const ct = res.headers.get('content-type') || '';
      if (!res.ok) {
        let detail = '';
        try { detail = ct.includes('application/json') ? JSON.stringify(await res.json()) : await res.text(); } catch {}
        throw new Error(`HTTP ${res.status} ‚Äì ${detail || 'Y√™u c·∫ßu th·∫•t b·∫°i'}`);
      }
      if (!ct.includes('application/json')) throw new Error('Ph·∫£n h·ªìi kh√¥ng ph·∫£i JSON (c√≥ th·ªÉ b·ªã chuy·ªÉn h∆∞·ªõng ƒëƒÉng nh·∫≠p).');
      return res.json();
    }

    function toast(msg, type='danger') {
      let box = document.getElementById('global-toast');
      if (!box) {
        box = document.createElement('div'); box.id='global-toast';
        box.style.position='fixed'; box.style.right='16px'; box.style.bottom='16px'; box.style.zIndex='1080';
        document.body.appendChild(box);
      }
      const el = document.createElement('div');
      el.className = `alert alert-${type} shadow-sm`;
      el.textContent = msg;
      box.appendChild(el);
      setTimeout(() => el.remove(), 2500);
    }

    // ===== DOM refs =====
    const elLoading   = document.getElementById('cart-loading');
    const elEmpty     = document.getElementById('cart-empty');
    const elError     = document.getElementById('cart-error');
    const elWrap      = document.getElementById('order-summary-wrap');
    const elLinesBody = document.getElementById('order-lines');
    const elSub       = document.getElementById('sum-subtotal');
    const elShip      = document.getElementById('sum-shipping');
    const elTotal     = document.getElementById('sum-total');
    const elConfirm   = document.getElementById('confirmBtn');
    const elBtnText   = elConfirm.querySelector('.btn-text');
    const elBtnSpin   = elConfirm.querySelector('.btn-spin');

    const bankOption = document.getElementById("bank");
    const codOption  = document.getElementById("cod");
    const bankInfo   = document.getElementById("bankInfo");

    // ===== Cart render =====
    function rowTpl(line) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="text-start">${line.productName}</td>
        <td>${line.quantity}</td>
        <td class="text-end">${fmtVND(line.price)}</td>
        <td class="text-end fw-semibold">${fmtVND(line.lineTotal)}</td>`;
      return tr;
    }

    function renderCart(cart) {
      elLinesBody.innerHTML = '';
      (cart.lines || []).forEach(l => elLinesBody.appendChild(rowTpl(l)));
      elSub.textContent = fmtVND(cart.subtotal);
      elShip.textContent= fmtVND(cart.shipping);
      elTotal.textContent=fmtVND(cart.total);
    }

    // ===== API =====
    async function apiGetCart() {
      return fetchJson(API_BASE, { headers: buildCsrfHeaders() });
    }
    async function apiCheckout(payload) {
      return fetchJson(`${API_BASE}/checkout`, {
        method: 'POST',
        headers: buildJsonHeaders(),
        body: JSON.stringify(payload)
      });
    }

    // ===== Init =====
    async function init() {
      try {
        elLoading.classList.remove('d-none');
        const cart = await apiGetCart();

        if (!cart || !cart.lines || cart.lines.length === 0) {
          elEmpty.classList.remove('d-none');
          elWrap.classList.add('d-none');
          elConfirm.disabled = true;
        } else {
          renderCart(cart);
          elWrap.classList.remove('d-none');
          elEmpty.classList.add('d-none');
          elConfirm.disabled = false;
        }
      } catch (err) {
        elError.textContent = err.message || 'Kh√¥ng t·∫£i ƒë∆∞·ª£c gi·ªè h√†ng.';
        elError.classList.remove('d-none');
        elWrap.classList.add('d-none');
        elConfirm.disabled = true;
      } finally {
        elLoading.classList.add('d-none');
      }
    }

    // ===== Events =====
    bankOption.addEventListener("change", () => { if (bankOption.checked) bankInfo.style.display = "block"; });
    codOption .addEventListener("change", () => { if (codOption.checked)  bankInfo.style.display = "none";  });

    elConfirm.addEventListener('click', async (e) => {
      e.preventDefault();
      const recipientName   = document.getElementById("name").value.trim();
      const recipientPhone  = document.getElementById("phone").value.trim();
      const shippingAddress = document.getElementById("address").value.trim();
      const note            = document.getElementById("note").value.trim();
      const paymentMethod   = document.querySelector('input[name="payment"]:checked')?.value || 'COD';

      if (!recipientName || !recipientPhone || !shippingAddress) {
        toast('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin giao h√†ng!', 'warning');
        return;
      }

      try {
        elConfirm.disabled = true;
        elBtnText.classList.add('d-none');
        elBtnSpin.classList.remove('d-none');

        const orderId = await apiCheckout({ recipientName, recipientPhone, shippingAddress, note, paymentMethod });

        toast('ƒê·∫∑t h√†ng th√†nh c√¥ng! ƒêang chuy·ªÉn trang...', 'success');
        document.dispatchEvent(new CustomEvent('cart:updated')); // ƒë·ªÉ header c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng n·∫øu c√≥
        // ƒêi·ªÅu h∆∞·ªõng t·ªõi trang chi ti·∫øt ƒë∆°n (ƒëi·ªÅu ch·ªânh n·∫øu route kh√°c)
        setTimeout(() => {
          window.location.href = `/orders/${orderId}`;
        }, 800);
      } catch (err) {
        const msg = err.message || 'ƒê·∫∑t h√†ng th·∫•t b·∫°i, vui l√≤ng th·ª≠ l·∫°i.';
        // N·∫øu c√≥ kh·∫£ nƒÉng ch∆∞a ƒëƒÉng nh·∫≠p
        if (/HTTP 401|HTTP 403/.test(msg)) {
          toast('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ thanh to√°n.', 'warning');
          setTimeout(() => { window.location.href = '/login'; }, 700);
        } else {
          toast(msg, 'danger');
        }
      } finally {
        elBtnSpin.classList.add('d-none');
        elBtnText.classList.remove('d-none');
        elConfirm.disabled = false;
      }
    });

    // Go!
    init();
  </script>
</body>
</html>
