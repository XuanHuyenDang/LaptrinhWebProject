<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Thanh to√°n ƒë∆°n h√†ng - Florio Flower Shop</title>
  <meta name="_csrf" th:if="${_csrf}" th:content="${_csrf.token}">
  <meta name="_csrf_header" th:if="${_csrf}" th:content="${_csrf.headerName}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { background: #f8f9fa; }
    .section-title { font-weight: 600; }
    .btn-spinner {
      display: inline-flex; align-items:center; gap:.5rem;
    }
    .btn-spinner .spinner-border { width:1rem; height:1rem; }
    .badge-legend { font-size:.85rem; opacity:.9; }
  </style>
</head>
<body class="bg-light">

<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="container" style="max-width: 980px;">
  <h3 class="text-center text-danger my-4"><i class="bi bi-credit-card"></i> Thanh to√°n ƒë∆°n h√†ng</h3>
  
  <script th:inline="javascript">
    // Bi·∫øn c·ªù x√°c ƒë·ªãnh lu·ªìng
    const IS_BUY_NOW = /*[[${isBuyNow}]]*/ false;
    
    // Th√¥ng tin s·∫£n ph·∫©m Mua Ngay (ch·ªâ c√≥ gi√° tr·ªã n·∫øu IS_BUY_NOW = true)
    const BUY_NOW_PRODUCT_ID = /*[[${buyNowProductId}]]*/ null;
    const BUY_NOW_QTY = /*[[${buyNowQty}]]*/ null;

    // CartView (ho·∫∑c l√† cart th·∫≠t, ho·∫∑c l√† cart "·∫£o" t·ª´ controller)
    let CART = /*[[${cart}]]*/ null;

    // URL API
    const API_BASE = /*[[@{/api/cart}]]*/ '/api/cart';
    // URL trang ƒëƒÉng nh·∫≠p (ƒë·ªÉ x·ª≠ l√Ω l·ªói 401)
    const LOGIN_URL = /*[[@{/auth/login}]]*/ '/auth/login';
    // URL trang s·∫£n ph·∫©m (ƒë·ªÉ x·ª≠ l√Ω gi·ªè h√†ng tr·ªëng)
    const PRODUCTS_URL = /*[[@{/products}]]*/ '/products';
  </script>
  

  <div class="row g-4">
    <div class="col-lg-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="section-title mb-3"><i class="bi bi-truck"></i> Th√¥ng tin giao h√†ng</h5>

          <div class="mb-3">
            <label class="form-label">H·ªç v√† t√™n *</label>
            <input id="name" type="text" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">S·ªë ƒëi·ªán tho·∫°i *</label>
            <input id="phone" type="text" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">ƒê·ªãa ch·ªâ giao h√†ng *</label>
            <input id="address" type="text" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Ghi ch√∫</label>
            <textarea id="note" rows="2" class="form-control" placeholder="V√≠ d·ª•: Giao gi·ªù h√†nh ch√≠nh, g·ªçi tr∆∞·ªõc..."></textarea>
          </div>

          <h6 class="mb-2">H√¨nh th·ª©c thanh to√°n</h6>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="pay" id="payCOD" value="COD" checked>
            <label class="form-check-label" for="payCOD">üíµ Thanh to√°n khi nh·∫≠n h√†ng (COD)</label>
          </div>
          <div class="form-check mb-3">
            <input class="form-check-input" type="radio" name="pay" id="payBANK" value="BANK">
            <label class="form-check-label" for="payBANK">üí≥ Chuy·ªÉn kho·∫£n ng√¢n h√†ng</label>
          </div>

          <div id="bankInfo" class="alert alert-secondary small d-none">
            <strong>Ng√¢n h√†ng:</strong> Vietcombank<br>
            <strong>S·ªë TK:</strong> 0123456789 (Florio Flower Shop)<br>
            <strong>N·ªôi dung:</strong> [T√™n KH] - [SƒêT] - Thanh to√°n ƒë∆°n h√†ng
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="section-title mb-3"><i class="bi bi-receipt"></i> T√≥m t·∫Øt ƒë∆°n h√†ng</h5>

          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead class="table-light">
                <tr>
                  <th>S·∫£n ph·∫©m</th>
                  <th class="text-center">SL</th>
                  <th class="text-end">ƒê∆°n gi√°</th>
                  <th class="text-end">Th√†nh ti·ªÅn</th>
                </tr>
              </thead>
              <tbody id="cart-lines"></tbody>
            </table>
          </div>

          <div class="mb-3">
            <h6 class="mb-2">Ph∆∞∆°ng th·ª©c giao h√†ng</h6>

            <div class="form-check">
              <input class="form-check-input ship" type="radio" name="ship" id="shipSaving" value="SAVING">
              <label class="form-check-label" for="shipSaving">
                <span class="badge text-bg-success badge-legend">SAVING</span> ‚Äì Giao ti·∫øt ki·ªám (20.000ƒë)
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input ship" type="radio" name="ship" id="shipFast" value="FAST" checked>
              <label class="form-check-label" for="shipFast">
                <span class="badge text-bg-primary badge-legend">FAST</span> ‚Äì Giao nhanh (30.000ƒë)
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input ship" type="radio" name="ship" id="shipExpress" value="EXPRESS">
              <label class="form-check-label" for="shipExpress">
                <span class="badge text-bg-danger badge-legend">EXPRESS</span> ‚Äì H·ªèa t·ªëc (60.000ƒë)
              </label>
            </div>
          </div>

          <ul class="list-group mb-3">
            <li class="list-group-item d-flex justify-content-between">
              <span>T·∫°m t√≠nh</span><strong id="sum-subtotal">0ƒë</strong>
            </li>
            <li class="list-group-item d-flex justify-content-between">
              <span>Ph√≠ v·∫≠n chuy·ªÉn</span><strong id="sum-ship">0ƒë</strong>
            </li>
            <li class="list-group-item d-flex justify-content-between">
              <span>T·ªïng c·ªông</span><strong id="sum-total" class="text-danger">0ƒë</strong>
            </li>
          </ul>

          <button id="btnCheckout" class="btn btn-danger w-100 btn-spinner">
            <span class="lbl"><i class="bi bi-bag-check"></i> X√°c nh·∫≠n ƒë·∫∑t h√†ng</span>
            <span class="spinner-border d-none" role="status" aria-hidden="true"></span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script th:inline="javascript">
  // ƒê·ªãnh d·∫°ng ti·ªÅn
  const fmtVND = (n) => {
    try { return new Intl.NumberFormat('vi-VN').format(n ?? 0) + 'ƒë'; }
    catch { return (n ?? 0) + 'ƒë'; }
  };

  // L·∫•y CSRF token
  function csrfHeaders(){
    const h = {};
    const t = document.querySelector('meta[name="_csrf"]')?.content;
    const hn= document.querySelector('meta[name="_csrf_header"]')?.content;
    if (t && hn) h[hn]=t;
    return h;
  }

  // H√†m g·ªçi API
  async function fetchJson(url, opt = {}){
    const res = await fetch(url, opt);
    const ct = res.headers.get('content-type')||'';
    if(!res.ok){
      let msg=''; try{ msg = ct.includes('json') ? JSON.stringify(await res.json()) : await res.text(); }catch{}
      if (res.status === 401) {
          // S·ª≠ d·ª•ng LOGIN_URL ƒë√£ ƒë·ªãnh nghƒ©a ·ªü tr√™n
          window.location.href = LOGIN_URL;
          throw new Error('Ch∆∞a ƒëƒÉng nh·∫≠p.');
      }
      throw new Error(`HTTP ${res.status} ‚Äì ${msg||'Y√™u c·∫ßu th·∫•t b·∫°i'}`);
    }
    // Ch·ªâ parse JSON n·∫øu c√≥
    if(ct.includes('json')) {
        return res.json();
    }
    // N·∫øu kh√¥ng ph·∫£i JSON (v√≠ d·ª• 401 redirect HTML)
    return null;
  }

  // Ph√≠ ship FE ‚Äì ph·∫£i ƒë·ªìng b·ªô v·ªõi BE (CartService.shippingFeeFor)
  function shipFee(method, subtotal){
    if (subtotal <= 0) return 0;
    if(method==='SAVING')  return 20000;
    if(method==='EXPRESS') return 60000;
    // FAST (m·∫∑c ƒë·ªãnh)
    if (subtotal >= 500000) return 0; // Mi·ªÖn ph√≠ ship
    return 30000;
  }

  // State
  let SHIP_METHOD = 'FAST';

  // Render cart lines
  function renderCart(cart){
    if (!cart || !cart.lines || cart.lines.length === 0) {
        alert('Gi·ªè h√†ng tr·ªëng ho·∫∑c c√≥ l·ªói, quay v·ªÅ trang s·∫£n ph·∫©m.');
        // S·ª≠ d·ª•ng PRODUCTS_URL ƒë√£ ƒë·ªãnh nghƒ©a ·ªü tr√™n
        window.location.href = PRODUCTS_URL;
        return;
    }
    const tbody = document.getElementById('cart-lines');
    tbody.innerHTML = '';
    (cart.lines||[]).forEach(l=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${l.productName}</td>
        <td class="text-center">${l.quantity}</td>
        <td class="text-end">${fmtVND(l.price)}</td>
        <td class="text-end">${fmtVND(l.lineTotal)}</td>
      `;
      tbody.appendChild(tr);
    });
    updateSummary();
  }

  // C·∫≠p nh·∫≠t T√≥m t·∫Øt ƒë∆°n h√†ng
  function updateSummary(){
    const subtotal = CART?.subtotal || 0;
    // T√≠nh ph√≠ ship d·ª±a tr√™n subtotal
    const fee = shipFee(SHIP_METHOD, subtotal); 
    const total = subtotal + fee;

    document.getElementById('sum-subtotal').textContent = fmtVND(subtotal);
    document.getElementById('sum-ship').textContent     = fmtVND(fee);
    document.getElementById('sum-total').textContent    = fmtVND(total);
  }

  // Bank info toggle
  document.getElementById('payBANK').addEventListener('change', e=>{
    document.getElementById('bankInfo').classList.toggle('d-none', !e.target.checked);
  });
  document.getElementById('payCOD').addEventListener('change', e=>{
    if(e.target.checked) document.getElementById('bankInfo').classList.add('d-none');
  });

  // Ship method change
  document.querySelectorAll('input.ship').forEach(r=>{
    r.addEventListener('change', ()=>{
      if(r.checked){ SHIP_METHOD = r.value; updateSummary(); }
    });
  });

  // N√∫t x√°c nh·∫≠n (th√™m spinner/disable)
  const btnCheckout = document.getElementById('btnCheckout');
  function setBusy(on){
    btnCheckout.disabled = on;
    btnCheckout.querySelector('.spinner-border').classList.toggle('d-none', !on);
    btnCheckout.querySelector('.lbl').classList.toggle('d-none', on);
  }

  // Submit checkout (LOGIC ƒê√É S·ª¨A)
  btnCheckout.addEventListener('click', async ()=>{
    const name = document.getElementById('name').value.trim();
    const phone= document.getElementById('phone').value.trim();
    const addr = document.getElementById('address').value.trim();
    const note = document.getElementById('note').value.trim();
    const pay  = document.getElementById('payBANK').checked ? 'BANK' : 'COD';

    if(!name || !phone || !addr){
      alert('Vui l√≤ng ƒëi·ªÅn ƒë·ªß H·ªç t√™n, SƒêT v√† ƒê·ªãa ch·ªâ.');
      return;
    }

    // 1. T·∫°o ƒë·ªëi t∆∞·ª£ng th√¥ng tin thanh to√°n chung
    const checkoutRequest = {
      recipientName: name,
      recipientPhone: phone,
      shippingAddress: addr,
      note: note || null,
      paymentMethod: pay,
      shippingMethod: SHIP_METHOD
    };

    try{
      setBusy(true);
      let url = '';
      let body;

      if (IS_BUY_NOW) {
        // === LU·ªíNG MUA NGAY ===
        url = `${API_BASE}/checkout/buy-now`;
        body = JSON.stringify({
          checkout: checkoutRequest, // Th√¥ng tin ng∆∞·ªùi nh·∫≠n
          productId: BUY_NOW_PRODUCT_ID, // S·∫£n ph·∫©m
          quantity: BUY_NOW_QTY         // S·ªë l∆∞·ª£ng
        });

      } else {
        // === LU·ªíNG GI·ªé H√ÄNG (NH∆Ø C≈®) ===
        url = `${API_BASE}/checkout`;
        body = JSON.stringify(checkoutRequest);
      }

      // 2. G·ª≠i API
      const orderId = await fetchJson(url, {
        method:'POST',
        headers: { 'Content-Type':'application/json', ...csrfHeaders() },
        body
      });
      
      if(orderId === null) {
          // X·ª≠ l√Ω tr∆∞·ªùng h·ª£p fetchJson tr·∫£ v·ªÅ null (v√≠ d·ª•: l·ªói 401 ƒë√£ b·ªã x·ª≠ l√Ω)
          throw new Error("Phi√™n l√†m vi·ªác ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.");
      }

      // 3. ƒêi·ªÅu h∆∞·ªõng
      window.location.href = `/orders/${orderId}`;
      
    }catch(err){
      alert(err.message || 'ƒê·∫∑t h√†ng th·∫•t b·∫°i, vui l√≤ng th·ª≠ l·∫°i.');
    }finally{
      setBusy(false);
    }
  });

  // Init: n·∫°p gi·ªè h√†ng (LOGIC ƒê√É S·ª¨A)
  (async function init(){
    try{
      // N·∫øu kh√¥ng ph·∫£i "Mua ngay", th√¨ m·ªõi fetch gi·ªè h√†ng th·∫≠t
      if (!IS_BUY_NOW) {
          CART = await fetchJson(API_BASE, { headers: csrfHeaders() });
      }
      // N·∫øu l√† "Mua ngay", CART ƒë√£ ƒë∆∞·ª£c set ·ªü ƒë·∫ßu file t·ª´ Thymeleaf
      
      // Render gi·ªè h√†ng (th·∫≠t ho·∫∑c ·∫£o)
      renderCart(CART);
      
    }catch(err){
      // L·ªói n√†y ch·ªâ x·∫£y ra n·∫øu fetch gi·ªè h√†ng th·∫≠t b·ªã l·ªói (401 ƒë√£ b·ªã x·ª≠ l√Ω)
      alert(err.message || 'Kh√¥ng t·∫£i ƒë∆∞·ª£c gi·ªè h√†ng.');
    }
  })();
</script>

<div th:replace="~{fragments/footer :: footer}"></div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>