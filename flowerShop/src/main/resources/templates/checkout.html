<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Thanh to√°n ƒë∆°n h√†ng - Florio Flower Shop</title>
  <!-- CSRF cho fetch -->
  <meta name="_csrf" th:if="${_csrf}" th:content="${_csrf.token}">
  <meta name="_csrf_header" th:if="${_csrf}" th:content="${_csrf.headerName}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { background: #f8f9fa; }
    .section-title { font-weight: 600; }
    .btn-spinner {
      display: inline-flex; align-items:center; gap:.5rem;
    }
    .btn-spinner .spinner-border { width:1rem; height:1rem; }
    .badge-legend { font-size:.85rem; opacity:.9; }
  </style>
</head>
<body class="bg-light">

<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="container" style="max-width: 980px;">
  <h3 class="text-center text-danger my-4"><i class="bi bi-credit-card"></i> Thanh to√°n ƒë∆°n h√†ng</h3>

  <div class="row g-4">
    <!-- Th√¥ng tin giao h√†ng -->
    <div class="col-lg-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="section-title mb-3"><i class="bi bi-truck"></i> Th√¥ng tin giao h√†ng</h5>

          <div class="mb-3">
            <label class="form-label">H·ªç v√† t√™n *</label>
            <input id="name" type="text" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">S·ªë ƒëi·ªán tho·∫°i *</label>
            <input id="phone" type="text" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">ƒê·ªãa ch·ªâ giao h√†ng *</label>
            <input id="address" type="text" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Ghi ch√∫</label>
            <textarea id="note" rows="2" class="form-control" placeholder="V√≠ d·ª•: Giao gi·ªù h√†nh ch√≠nh, g·ªçi tr∆∞·ªõc..."></textarea>
          </div>

          <h6 class="mb-2">H√¨nh th·ª©c thanh to√°n</h6>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="pay" id="payCOD" value="COD" checked>
            <label class="form-check-label" for="payCOD">üíµ Thanh to√°n khi nh·∫≠n h√†ng (COD)</label>
          </div>
          <div class="form-check mb-3">
            <input class="form-check-input" type="radio" name="pay" id="payBANK" value="BANK">
            <label class="form-check-label" for="payBANK">üí≥ Chuy·ªÉn kho·∫£n ng√¢n h√†ng</label>
          </div>

          <div id="bankInfo" class="alert alert-secondary small d-none">
            <strong>Ng√¢n h√†ng:</strong> Vietcombank<br>
            <strong>S·ªë TK:</strong> 0123456789 (Florio Flower Shop)<br>
            <strong>N·ªôi dung:</strong> [T√™n KH] - [SƒêT] - Thanh to√°n ƒë∆°n h√†ng
          </div>
        </div>
      </div>
    </div>

    <!-- T√≥m t·∫Øt + ph∆∞∆°ng th·ª©c giao h√†ng -->
    <div class="col-lg-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="section-title mb-3"><i class="bi bi-receipt"></i> T√≥m t·∫Øt ƒë∆°n h√†ng</h5>

          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead class="table-light">
                <tr>
                  <th>S·∫£n ph·∫©m</th>
                  <th class="text-center">SL</th>
                  <th class="text-end">ƒê∆°n gi√°</th>
                  <th class="text-end">Th√†nh ti·ªÅn</th>
                </tr>
              </thead>
              <tbody id="cart-lines"></tbody>
            </table>
          </div>

          <div class="mb-3">
            <h6 class="mb-2">Ph∆∞∆°ng th·ª©c giao h√†ng</h6>

            <div class="form-check">
              <input class="form-check-input ship" type="radio" name="ship" id="shipSaving" value="SAVING">
              <label class="form-check-label" for="shipSaving">
                <span class="badge text-bg-success badge-legend">SAVING</span> ‚Äì Giao ti·∫øt ki·ªám (20.000ƒë)
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input ship" type="radio" name="ship" id="shipFast" value="FAST" checked>
              <label class="form-check-label" for="shipFast">
                <span class="badge text-bg-primary badge-legend">FAST</span> ‚Äì Giao nhanh (30.000ƒë)
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input ship" type="radio" name="ship" id="shipExpress" value="EXPRESS">
              <label class="form-check-label" for="shipExpress">
                <span class="badge text-bg-danger badge-legend">EXPRESS</span> ‚Äì H·ªèa t·ªëc (60.000ƒë)
              </label>
            </div>
          </div>

          <ul class="list-group mb-3">
            <li class="list-group-item d-flex justify-content-between">
              <span>T·∫°m t√≠nh</span><strong id="sum-subtotal">0ƒë</strong>
            </li>
            <li class="list-group-item d-flex justify-content-between">
              <span>Ph√≠ v·∫≠n chuy·ªÉn</span><strong id="sum-ship">0ƒë</strong>
            </li>
            <li class="list-group-item d-flex justify-content-between">
              <span>T·ªïng c·ªông</span><strong id="sum-total" class="text-danger">0ƒë</strong>
            </li>
          </ul>

          <button id="btnCheckout" class="btn btn-danger w-100 btn-spinner">
            <span class="lbl"><i class="bi bi-bag-check"></i> X√°c nh·∫≠n ƒë·∫∑t h√†ng</span>
            <span class="spinner-border d-none" role="status" aria-hidden="true"></span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script th:inline="javascript">
  const API_BASE = /*[[@{/api/cart}]]*/ '/api/cart';

  // ƒê·ªãnh d·∫°ng ti·ªÅn kh·ªõp v·ªõi order-success (ƒëu√¥i 'ƒë')
  const fmtVND = (n) => {
    try { return new Intl.NumberFormat('vi-VN').format(n ?? 0) + 'ƒë'; }
    catch { return (n ?? 0) + 'ƒë'; }
  };

  function csrfHeaders(){
    const h = {};
    const t = document.querySelector('meta[name="_csrf"]')?.content;
    const hn= document.querySelector('meta[name="_csrf_header"]')?.content;
    if (t && hn) h[hn]=t;
    return h;
  }

  async function fetchJson(url, opt = {}){
    const res = await fetch(url, opt);
    const ct = res.headers.get('content-type')||'';
    if(!res.ok){
      let msg=''; try{ msg = ct.includes('json') ? JSON.stringify(await res.json()) : await res.text(); }catch{}
      throw new Error(`HTTP ${res.status} ‚Äì ${msg||'Y√™u c·∫ßu th·∫•t b·∫°i'}`);
    }
    if(!ct.includes('json')) throw new Error('Ph·∫£n h·ªìi kh√¥ng ph·∫£i JSON (c√≥ th·ªÉ h·∫øt phi√™n).');
    return res.json();
  }

  // Ph√≠ ship FE ‚Äì ph·∫£i ƒë·ªìng b·ªô v·ªõi BE (CartService.shippingFeeFor)
  function shipFee(method){
    if(method==='SAVING')  return 20000;
    if(method==='EXPRESS') return 60000;
    return 30000; // FAST
  }

  // State
  let CART = null;
  let SHIP_METHOD = 'FAST';

  // Render cart lines & summary
  function renderCart(cart){
    const tbody = document.getElementById('cart-lines');
    tbody.innerHTML = '';
    (cart.lines||[]).forEach(l=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${l.productName}</td>
        <td class="text-center">${l.quantity}</td>
        <td class="text-end">${fmtVND(l.price)}</td>
        <td class="text-end">${fmtVND(l.lineTotal)}</td>
      `;
      tbody.appendChild(tr);
    });
    updateSummary();
  }

  function updateSummary(){
    const subtotal = CART?.subtotal || 0;
    const fee = shipFee(SHIP_METHOD);
    const total = subtotal + fee;

    document.getElementById('sum-subtotal').textContent = fmtVND(subtotal);
    document.getElementById('sum-ship').textContent     = fmtVND(fee);
    document.getElementById('sum-total').textContent    = fmtVND(total);
  }

  // Bank info toggle
  document.getElementById('payBANK').addEventListener('change', e=>{
    document.getElementById('bankInfo').classList.toggle('d-none', !e.target.checked);
  });
  document.getElementById('payCOD').addEventListener('change', e=>{
    if(e.target.checked) document.getElementById('bankInfo').classList.add('d-none');
  });

  // Ship method change
  document.querySelectorAll('input.ship').forEach(r=>{
    r.addEventListener('change', ()=>{
      if(r.checked){ SHIP_METHOD = r.value; updateSummary(); }
    });
  });

  // N√∫t x√°c nh·∫≠n (th√™m spinner/disable ƒë·ªÉ kh·ªõp UX)
  const btnCheckout = document.getElementById('btnCheckout');
  function setBusy(on){
    btnCheckout.disabled = on;
    btnCheckout.querySelector('.spinner-border').classList.toggle('d-none', !on);
    btnCheckout.querySelector('.lbl').classList.toggle('d-none', on);
  }

  // Submit checkout
  btnCheckout.addEventListener('click', async ()=>{
    const name = document.getElementById('name').value.trim();
    const phone= document.getElementById('phone').value.trim();
    const addr = document.getElementById('address').value.trim();
    const note = document.getElementById('note').value.trim();
    const pay  = document.getElementById('payBANK').checked ? 'BANK' : 'COD';

    if(!name || !phone || !addr){
      alert('Vui l√≤ng ƒëi·ªÅn ƒë·ªß H·ªç t√™n, SƒêT v√† ƒê·ªãa ch·ªâ.');
      return;
    }

    try{
      setBusy(true);
      const body = JSON.stringify({
        recipientName: name,
        recipientPhone: phone,
        shippingAddress: addr,
        note: note || null,
        paymentMethod: pay,        // "COD" | "BANK"
        shippingMethod: SHIP_METHOD // "SAVING" | "FAST" | "EXPRESS"
      });

      // BE s·∫Ω set: status="PENDING", shippingFee = theo method, totalAmount = subtotal + shippingFee
      const orderId = await fetchJson(`${API_BASE}/checkout`, {
        method:'POST',
        headers: { 'Content-Type':'application/json', ...csrfHeaders() },
        body
      });

      // ƒêi·ªÅu h∆∞·ªõng sang trang th√†nh c√¥ng /orders/{id} (CheckoutController ƒë√£ chu·∫©n b·ªã view order-success)
      window.location.href = `/orders/${orderId}`;
    }catch(err){
      alert(err.message || 'ƒê·∫∑t h√†ng th·∫•t b·∫°i, vui l√≤ng th·ª≠ l·∫°i.');
      if(String(err.message).includes('401')) window.location.href='/login';
    }finally{
      setBusy(false);
    }
  });

  // Init: n·∫°p gi·ªè h√†ng
  (async function init(){
    try{
      CART = await fetchJson(API_BASE, { headers: csrfHeaders() });
      if(!CART || !CART.lines || CART.lines.length===0){
        alert('Gi·ªè h√†ng tr·ªëng, vui l√≤ng ch·ªçn s·∫£n ph·∫©m.');
        window.location.href='/products';
        return;
      }
      renderCart(CART);
    }catch(err){
      alert(err.message || 'Kh√¥ng t·∫£i ƒë∆∞·ª£c gi·ªè h√†ng.');
      if(String(err.message).includes('401')) window.location.href='/login';
    }
  })();
</script>

<div th:replace="~{fragments/footer :: footer}"></div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
