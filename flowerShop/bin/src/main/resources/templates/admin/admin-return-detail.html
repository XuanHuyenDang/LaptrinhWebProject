<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Chi tiết Yêu cầu Trả hàng - Florio Admin</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<style>
/* (Sao chép style từ các trang admin khác) */
body { background-color: #fffafc; font-family: "Segoe UI", sans-serif; }
.sidebar { position: fixed; top: 0; left: 0; height: 100vh; width: 250px; background: linear-gradient(180deg, #ffb6c1 0%, #ffe5ec 100%); color: #4a4a4a; padding-top: 1rem; box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1); }
.sidebar h5 { font-weight: bold; color: #c2185b; }
.sidebar a { color: #5a5a5a; text-decoration: none; display: block; padding: 10px 20px; border-radius: 8px; margin: 3px 10px; transition: all 0.3s ease; font-weight: 500; }
.sidebar a:hover, .sidebar a.active { background: #fff; color: #c2185b; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15); transform: translateX(3px); }
.sidebar i { color: #c2185b; }
main { margin-left: 270px; padding: 30px; }
.card { border-radius: 15px; border: none; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08); }
h3, h5 { color: #c2185b; font-weight: 700; }
.evidence-media { max-width: 100%; border-radius: 8px; border: 1px solid #ddd; }
.logout-form {
  position: absolute;
  bottom: 160px;        /* Cố định ở gần cuối sidebar */
  left: 45%;
  transform: translateX(-50%); /* Căn giữa theo chiều ngang */
  text-align: center;
}
</style>
</head>
<body>

	<div th:replace="~{admin/fragments/sidebar :: sidebar(page='returns')}"></div>

	<main>
		<div class="d-flex align-items-center justify-content-between mb-4">
			<h3>Chi tiết Yêu cầu Trả hàng <span th:text="'#RT' + ${returnRequest.id}"></span></h3>
			<a th:href="@{/admin/returns}" class="btn btn-sm btn-outline-secondary">
				<i class="bi bi-arrow-left me-1"></i> Quay lại danh sách
			</a>
		</div>

        <div class="row g-4">
            <div class="col-lg-6">
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0 fs-6 fw-bold text-secondary">Thông tin Yêu cầu</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Đơn hàng:</strong>
                            <a th:href="@{/admin/orders/{id}(id=${returnRequest.order.id})}" th:text="'#' + ${returnRequest.order.id}"></a>
                        </p>
                        <p><strong>Khách hàng:</strong>
                            <span th:text="${returnRequest.order.recipientName}"></span>
                        </p>
                        <p><strong>Ngày yêu cầu:</strong>
                            <span th:text="${#temporals.format(returnRequest.requestDate, 'dd/MM/yyyy HH:mm')}"></span>
                        </p>
                         <p><strong>Trạng thái:</strong>
                            <span class="badge bg-warning text-dark" th:text="${returnRequest.status}">PENDING</span>
                        </p>
                        <hr>
                        <p><strong>Lý do của khách:</strong></p>
                        <p class="p-2 bg-light rounded" th:text="${returnRequest.reason}"></p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0 fs-6 fw-bold text-secondary">Bằng chứng</h5>
                    </div>
                    <div class="card-body">
                        <th:block th:if="${returnRequest.evidenceUrl != null}">
                            <a th:href="@{/{url}(url=${returnRequest.evidenceUrl})}"
                               target="_blank">

                                <th:block th:with="lowerUrl=${#strings.toLowerCase(returnRequest.evidenceUrl)}">
                                    <img th:if="${#strings.endsWith(lowerUrl, '.png') or
                                                  #strings.endsWith(lowerUrl, '.jpg') or
                                                  #strings.endsWith(lowerUrl, '.jpeg') or
                                                  #strings.endsWith(lowerUrl, '.gif')}"
                                         th:src="@{/{url}(url=${returnRequest.evidenceUrl})}"
                                         class="evidence-media"
                                         alt="Bằng chứng">

                                    <span th:unless="${#strings.endsWith(lowerUrl, '.png') or
                                                     #strings.endsWith(lowerUrl, '.jpg') or
                                                     #strings.endsWith(lowerUrl, '.jpeg') or
                                                     #strings.endsWith(lowerUrl, '.gif')}">
                                        <i class="bi bi-film me-1"></i> Xem video/file bằng chứng
                                    </span>
                                </th:block>
                            </a>
                        </th:block>
                        <p th:if="${returnRequest.evidenceUrl == null}" class="text-muted">Không có bằng chứng được cung cấp.</p>
                    </div>
                    </div>
            </div>

            <div class="col-lg-6">
                 <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0 fs-6 fw-bold text-secondary">Hành động</h5>
                    </div>
                    <div class="card-body">
                        <p>Thực hiện duyệt hoặc từ chối yêu cầu này. Hành động này sẽ thay đổi trạng thái đơn hàng.</p>

                        <form id="processReturnForm" th:action="@{/admin/returns/process}" method="post">
                            <input type="hidden" th:if="${_csrf}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            <input type="hidden" name="requestId" th:value="${returnRequest.id}">
                            <input type="hidden" name="approve" id="approveActionInput" value="">

                            <div class="mb-3">
                                <label for="adminNotes" class="form-label">Ghi chú của Admin (*)</label>
                                <textarea class="form-control" id="adminNotes" name="adminNotes" rows="3"
                                          placeholder="Nhập lý do đồng ý hoặc từ chối..."
                                          required></textarea>
                            </div>

                            <div class="d-flex justify-content-end gap-2">
                                <button type="button" class="btn btn-danger btn-confirm-action"
                                        data-bs-toggle="modal"
                                        data-bs-target="#confirmationModal"
                                        data-action="false"
                                        data-action-text="TỪ CHỐI">
                                    <i class="bi bi-x-circle"></i> Từ chối
                                </button>
                                <button type="button" class="btn btn-success btn-confirm-action"
                                        data-bs-toggle="modal"
                                        data-bs-target="#confirmationModal"
                                        data-action="true"
                                        data-action-text="CHẤP NHẬN">
                                    <i class="bi bi-check-circle"></i> Chấp nhận
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
	</main>

    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="confirmationModalLabel">Xác nhận Hành động</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            Bạn có chắc chắn muốn <strong id="modalActionText"></strong> yêu cầu trả hàng này không?
            <br><small class="text-muted">Ghi chú của bạn sẽ được lưu lại.</small>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
            <button type="button" class="btn btn-primary" id="confirmActionButton">Xác nhận</button>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const confirmationModal = document.getElementById('confirmationModal');
        const modalActionText = document.getElementById('modalActionText');
        const confirmActionButton = document.getElementById('confirmActionButton');
        const processReturnForm = document.getElementById('processReturnForm');
        const approveActionInput = document.getElementById('approveActionInput');
        let currentAction = null; // Biến lưu hành động ('true' hoặc 'false')

        confirmationModal.addEventListener('show.bs.modal', event => {
            // Button đã kích hoạt modal
            const button = event.relatedTarget;
            // Lấy thông tin hành động từ data-* attributes
            currentAction = button.getAttribute('data-action');
            const actionText = button.getAttribute('data-action-text');
            // Cập nhật nội dung modal
            modalActionText.textContent = actionText;
        });

        confirmActionButton.addEventListener('click', () => {
             // Lấy ghi chú trước khi submit
            const adminNotes = document.getElementById('adminNotes').value.trim();
            if (adminNotes === '') {
                 alert('Vui lòng nhập ghi chú của Admin.');
                 // Đóng modal để admin nhập
                 const modal = bootstrap.Modal.getInstance(confirmationModal);
                 modal.hide();
                 document.getElementById('adminNotes').focus();
                 return; // Dừng lại
            }

            // Đặt giá trị cho hidden input
            if (currentAction !== null) {
                approveActionInput.value = currentAction;
                // Gửi form
                processReturnForm.submit();
            } else {
                console.error("Hành động không xác định.");
                 // Có thể thêm thông báo lỗi ở đây
            }
        });

        // Reset currentAction khi modal đóng (phòng trường hợp)
        confirmationModal.addEventListener('hidden.bs.modal', () => {
             currentAction = null;
             approveActionInput.value = ''; // Xóa giá trị hidden input
        });
    </script>

</body>
</html>