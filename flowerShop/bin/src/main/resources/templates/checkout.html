<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Thanh to√°n ƒë∆°n h√†ng - Florio Flower Shop</title>
  <meta name="_csrf" th:if="${_csrf}" th:content="${_csrf.token}">
  <meta name="_csrf_header" th:if="${_csrf}" th:content="${_csrf.headerName}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { background: #f8f9fa; }
    .section-title { font-weight: 600; }
    .btn-spinner { display: inline-flex; align-items:center; gap:.5rem; }
    .btn-spinner .spinner-border { width:1rem; height:1rem; }
    .badge-legend { font-size:.85rem; opacity:.9; }
    label[for="payVNPAY"] img { height: 20px; vertical-align: middle; margin-left: 5px; }
    /* Style cho ph·∫ßn gi·∫£m gi√° */
    .discount-section { margin-top: 1rem; }
    #discount-info .applied-code { font-weight: bold; color: #198754; }
    #discount-info .remove-discount { font-size: 0.8em; cursor: pointer; color: #dc3545; }
    .summary-discount-row { color: #198754; font-weight: 500;} /* M√†u xanh cho d√≤ng gi·∫£m gi√° */
  </style>
</head>
<body class="bg-light">

<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="container" style="max-width: 980px;">
  <h3 class="text-center text-danger my-4"><i class="bi bi-credit-card"></i> Thanh to√°n ƒë∆°n h√†ng</h3>

  <script th:inline="javascript">
    // Bi·∫øn c·ªù x√°c ƒë·ªãnh lu·ªìng
    const IS_BUY_NOW = /*[[${isBuyNow}]]*/ false;

    // Th√¥ng tin s·∫£n ph·∫©m Mua Ngay (ch·ªâ c√≥ gi√° tr·ªã n·∫øu IS_BUY_NOW = true)
    const BUY_NOW_PRODUCT_ID = /*[[${buyNowProductId}]]*/ null;
    const BUY_NOW_QTY = /*[[${buyNowQty}]]*/ null;

    // CartView (ho·∫∑c l√† cart th·∫≠t, ho·∫∑c l√† cart "·∫£o" t·ª´ controller)
    let CART = /*[[${cart}]]*/ null;

    // URL API
    const API_BASE = /*[[@{/api/cart}]]*/ '/api/cart';
    // URL trang ƒëƒÉng nh·∫≠p (ƒë·ªÉ x·ª≠ l√Ω l·ªói 401/403)
    const LOGIN_URL = /*[[@{/auth/login}]]*/ '/auth/login';
    // URL trang s·∫£n ph·∫©m (ƒë·ªÉ x·ª≠ l√Ω gi·ªè h√†ng tr·ªëng)
    const PRODUCTS_URL = /*[[@{/products}]]*/ '/products';
    // URL trang th√†nh c√¥ng (d√πng khi COD/BANK)
    const ORDER_SUCCESS_URL_BASE = /*[[@{/orders/}]]*/ '/orders/';
  </script>


  <div class="row g-4">
    <div class="col-lg-6">
       <div class="card shadow-sm">
         <div class="card-body">
           <h5 class="section-title mb-3"><i class="bi bi-truck"></i> Th√¥ng tin giao h√†ng</h5>

           <div class="mb-3">
             <label class="form-label">H·ªç v√† t√™n *</label>
             <input id="name" type="text" class="form-control" required th:value="${account?.fullName}">
           </div>
           <div class="mb-3">
             <label class="form-label">S·ªë ƒëi·ªán tho·∫°i *</label>
             <input id="phone" type="text" class="form-control" required th:value="${account?.phoneNumber}">
           </div>
           <div class="mb-3">
             <label class="form-label">ƒê·ªãa ch·ªâ giao h√†ng *</label>
             <input id="address" type="text" class="form-control" required th:value="${account?.address}">
           </div>
           <div class="mb-3">
             <label class="form-label">Ghi ch√∫</label>
             <textarea id="note" rows="2" class="form-control" placeholder="V√≠ d·ª•: Giao gi·ªù h√†nh ch√≠nh, g·ªçi tr∆∞·ªõc..."></textarea>
           </div>

           <h6 class="mb-2">H√¨nh th·ª©c thanh to√°n *</h6>
           <div class="form-check">
             <input class="form-check-input payment-method" type="radio" name="pay" id="payCOD" value="COD" checked>
             <label class="form-check-label" for="payCOD">üíµ Thanh to√°n khi nh·∫≠n h√†ng (COD)</label>
           </div>
           <div class="form-check">
              <input class="form-check-input payment-method" type="radio" name="pay" id="payVNPAY" value="VNPAY">
              <label class="form-check-label" for="payVNPAY">
                 üí≥ Thanh to√°n qua VNPAY
                 <img src="https://sandbox.vnpayment.vn/apis/assets/images/logo-vnpay-sm.png" alt="VNPAY Logo">
              </label>
           </div>
           <div class="form-check mb-3">
             <input class="form-check-input payment-method" type="radio" name="pay" id="payBANK" value="BANK">
             <label class="form-check-label" for="payBANK">üè¶ Chuy·ªÉn kho·∫£n ng√¢n h√†ng (Th·ªß c√¥ng)</label>
           </div>

           <div id="bankInfo" class="alert alert-secondary small d-none">
             <strong>Ng√¢n h√†ng:</strong> Vietcombank<br>
             <strong>S·ªë TK:</strong> 0123456789 (Florio Flower Shop)<br>
             <strong>N·ªôi dung:</strong> [T√™n KH] - [SƒêT] - Thanh to√°n ƒë∆°n h√†ng #[M√£ ƒë∆°n h√†ng]
             <br><small class="text-danger">L∆∞u √Ω: ƒê∆°n h√†ng ch·ªâ ƒë∆∞·ª£c x·ª≠ l√Ω sau khi shop x√°c nh·∫≠n ƒë√£ nh·∫≠n ƒë∆∞·ª£c chuy·ªÉn kho·∫£n.</small>
           </div>
         </div>
       </div>
    </div>

    <div class="col-lg-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="section-title mb-3"><i class="bi bi-receipt"></i> T√≥m t·∫Øt ƒë∆°n h√†ng</h5>

          <div id="checkout-error" class="alert alert-danger d-none"></div>
          <div id="discount-success" class="alert alert-success d-none"></div> <div class="table-responsive">
             <table class="table table-sm align-middle">
              <thead class="table-light">
                <tr>
                  <th>S·∫£n ph·∫©m</th>
                  <th class="text-center">SL</th>
                  <th class="text-end">ƒê∆°n gi√°</th>
                  <th class="text-end">Th√†nh ti·ªÅn</th>
                </tr>
              </thead>
              <tbody id="cart-lines">
                 <tr th:if="${cart != null and cart.lines != null}" th:each="line : ${cart.lines}">
                     <td th:text="${line.productName}">T√™n s·∫£n ph·∫©m</td>
                     <td class="text-center" th:text="${line.quantity}">1</td>
                     <td class="text-end" th:text="${#numbers.formatDecimal(line.price, 0, 'COMMA', 0, 'POINT')} + 'ƒë'">0ƒë</td>
                     <td class="text-end" th:text="${#numbers.formatDecimal(line.lineTotal, 0, 'COMMA', 0, 'POINT')} + 'ƒë'">0ƒë</td>
                 </tr>
              </tbody>
            </table>
          </div>

           <div class="discount-section">
               <label for="discountCodeInput" class="form-label">M√£ gi·∫£m gi√°</label>
               <div class="input-group">
                   <input type="text" class="form-control text-uppercase" id="discountCodeInput" placeholder="Nh·∫≠p m√£ gi·∫£m gi√°">
                   <button class="btn btn-outline-secondary" type="button" id="btnApplyDiscount">√Åp d·ª•ng</button>
               </div>
               <div id="discount-info" class="mt-2 small" th:classappend="${cart == null or cart.appliedDiscountCode == null} ? 'd-none'">
                   ƒê√£ √°p d·ª•ng m√£: <span class="applied-code" th:text="${cart?.appliedDiscountCode?.code}"></span>
                   <span class="remove-discount ms-2" id="btnRemoveDiscount" title="X√≥a m√£">[X√≥a]</span>
               </div>
               <div id="discount-error" class="text-danger small mt-1 d-none"></div>
           </div>
           <div class="mb-3 mt-3">
            <h6 class="mb-2">Ph∆∞∆°ng th·ª©c giao h√†ng *</h6>
             <div class="form-check">
               <input class="form-check-input ship-method" type="radio" name="ship" id="shipSaving" value="SAVING">
               <label class="form-check-label" for="shipSaving">
                 <span class="badge text-bg-success badge-legend">SAVING</span> ‚Äì Giao ti·∫øt ki·ªám (<span class="ship-cost" data-method="SAVING">20,000</span>ƒë)
               </label>
             </div>
             <div class="form-check">
               <input class="form-check-input ship-method" type="radio" name="ship" id="shipFast" value="FAST" checked>
               <label class="form-check-label" for="shipFast">
                 <span class="badge text-bg-primary badge-legend">FAST</span> ‚Äì Giao nhanh (<span class="ship-cost" data-method="FAST">30,000</span>ƒë, mi·ªÖn ph√≠ t·ª´ 500k)
               </label>
             </div>
             <div class="form-check">
               <input class="form-check-input ship-method" type="radio" name="ship" id="shipExpress" value="EXPRESS">
               <label class="form-check-label" for="shipExpress">
                 <span class="badge text-bg-danger badge-legend">EXPRESS</span> ‚Äì H·ªèa t·ªëc (<span class="ship-cost" data-method="EXPRESS">60,000</span>ƒë)
               </label>
             </div>
          </div>

          <ul class="list-group mb-3">
            <li class="list-group-item d-flex justify-content-between">
              <span>T·∫°m t√≠nh</span><strong id="sum-subtotal">0ƒë</strong>
            </li>
            <li class="list-group-item d-flex justify-content-between summary-discount-row d-none" id="sum-discount-row">
                 <span>Gi·∫£m gi√°</span><strong id="sum-discount">0ƒë</strong>
            </li>
            <li class="list-group-item d-flex justify-content-between">
              <span>Ph√≠ v·∫≠n chuy·ªÉn</span><strong id="sum-ship">0ƒë</strong>
            </li>
            <li class="list-group-item d-flex justify-content-between">
              <span>T·ªïng c·ªông</span><strong id="sum-total" class="text-danger">0ƒë</strong>
            </li>
          </ul>

          <button id="btnCheckout" class="btn btn-danger w-100 btn-spinner">
            <span class="lbl"><i class="bi bi-bag-check"></i> X√°c nh·∫≠n ƒë·∫∑t h√†ng</span>
            <span class="spinner-border d-none" role="status" aria-hidden="true"></span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script th:inline="javascript">
  // ƒê·ªãnh d·∫°ng ti·ªÅn Vi·ªát Nam
  const fmtVND = (n) => {
    try { return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND', maximumFractionDigits: 0 }).format(n ?? 0); }
    catch { return (n ?? 0) + 'ƒë'; }
  };

  // L·∫•y CSRF token t·ª´ th·∫ª meta
  function csrfHeaders(){
    const h = {};
    const t = document.querySelector('meta[name="_csrf"]')?.content;
    const hn= document.querySelector('meta[name="_csrf_header"]')?.content;
    if (t && hn) h[hn]=t;
    return h;
  }

  // H√†m g·ªçi API fetch JSON, x·ª≠ l√Ω l·ªói 401/403 v√† c√°c l·ªói kh√°c
  async function fetchJson(url, opt = {}){
    try {
        const res = await fetch(url, opt);
        const ct = res.headers.get('content-type')||'';

        if(!res.ok){
          let errorData = null;
          let errorMsg = `HTTP ${res.status} ‚Äì ${res.statusText || 'Y√™u c·∫ßu th·∫•t b·∫°i'}`;
          try {
             const textError = await res.text();
             // Try to parse JSON first for better error messages
             if (ct.includes('json')) {
                 try {
                    errorData = JSON.parse(textError);
                    if(errorData && errorData.message) errorMsg = errorData.message;
                    else if (errorData && typeof errorData === 'string') errorMsg = errorData; // Handle plain string error response
                    else errorMsg = textError || errorMsg; // Fallback to text if JSON parse works but no message field
                 } catch (jsonParseErr) {
                    errorMsg = textError || errorMsg; // Fallback to text if JSON parsing fails
                 }
             } else {
                 errorMsg = textError || errorMsg; // Use text error if not JSON
             }
          } catch(readErr) { /* Ignore read errors if response has no body */ }

          if (res.status === 401 || res.status === 403) {
              window.location.href = LOGIN_URL + '?redirect=' + encodeURIComponent(window.location.pathname + window.location.search);
              throw new Error('Y√™u c·∫ßu x√°c th·ª±c.');
          }
          throw new Error(errorMsg); // Use the potentially improved error message
        }

        if(ct.includes('json')) {
            return res.json();
        }
        return null;
    } catch (networkErr) {
        console.error("L·ªói m·∫°ng:", networkErr);
        // Rethrow original error if it's not a generic network error, otherwise provide a standard message
        if (networkErr.message && networkErr.message !== 'Failed to fetch') {
             throw networkErr;
        }
        throw new Error("L·ªói k·∫øt n·ªëi m·∫°ng. Vui l√≤ng ki·ªÉm tra l·∫°i.");
    }
  }

  // T√≠nh ph√≠ ship d·ª±a tr√™n ph∆∞∆°ng th·ª©c v√† t·ªïng ti·ªÅn h√†ng
  function shipFee(method, subtotal){
    const sub = Number(subtotal) || 0; // Ensure subtotal is a number
    if (sub <= 0) return 0;

    const feeMap = {
        SAVING: 20000,
        EXPRESS: 60000,
        FAST: (sub >= 500000) ? 0 : 30000
    };
    return feeMap[method] ?? feeMap['FAST'];
  }

  // ---- State ----
  let SHIP_METHOD = document.querySelector('input[name="ship"]:checked')?.value || 'FAST'; // Get initial checked value
  const checkoutErrorDiv = document.getElementById('checkout-error');
  // Discount related elements
  const discountErrorDiv = document.getElementById('discount-error');
  const discountSuccessDiv = document.getElementById('discount-success');
  const discountInfoDiv = document.getElementById('discount-info');
  const discountCodeInput = document.getElementById('discountCodeInput');
  const btnApplyDiscount = document.getElementById('btnApplyDiscount');
  const btnRemoveDiscount = document.getElementById('btnRemoveDiscount');


  // ---- Render UI ----
  // Render c√°c d√≤ng s·∫£n ph·∫©m trong gi·ªè h√†ng
  function renderCartLines(cart){
    const tbody = document.getElementById('cart-lines');
    tbody.innerHTML = ''; // Clear previous content
    if (!cart || !cart.lines || cart.lines.length === 0) {
        console.warn("Gi·ªè h√†ng r·ªóng ho·∫∑c kh√¥ng h·ª£p l·ªá ƒë·ªÉ render.");
        if (!IS_BUY_NOW) {
             alert('Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng.');
             window.location.href = PRODUCTS_URL;
        }
        // Disable checkout button if cart is empty
        if(btnCheckout) btnCheckout.classList.add('disabled');
        return;
    }
     // Enable checkout button if cart has items
    if(btnCheckout) btnCheckout.classList.remove('disabled');

    (cart.lines).forEach(l=>{
      const tr = document.createElement('tr');
      // Ensure values are defined before formatting/displaying
      const productName = l.productName || 'N/A';
      const quantity = l.quantity || 0;
      const price = l.price || 0;
      const lineTotal = l.lineTotal || 0;

      tr.innerHTML = `
        <td>${productName}</td>
        <td class="text-center">${quantity}</td>
        <td class="text-end">${fmtVND(price)}</td>
        <td class="text-end fw-semibold">${fmtVND(lineTotal)}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  // C·∫≠p nh·∫≠t ph·∫ßn T√≥m t·∫Øt ƒë∆°n h√†ng (bao g·ªìm discount)
  function updateSummary(){
    const subtotal = CART?.subtotal || 0;
    const fee = shipFee(SHIP_METHOD, subtotal);
    const discount = CART?.discount || 0;
    const total = Math.max(0, Number(subtotal) + Number(fee) - Number(discount)); // Ensure numeric calculation

    document.getElementById('sum-subtotal').textContent = fmtVND(subtotal);
    document.getElementById('sum-ship').textContent     = fmtVND(fee);
    document.getElementById('sum-discount').textContent = fmtVND(discount * -1); // Show as negative
    document.getElementById('sum-total').textContent    = fmtVND(total);

    // Show/hide discount row
    document.getElementById('sum-discount-row').classList.toggle('d-none', !(discount > 0));

    // Update shipping cost labels (optional)
    document.querySelectorAll('.ship-cost').forEach(span => {
        const method = span.dataset.method;
        if(method) { // Check if method exists
             const currentFee = shipFee(method, subtotal);
             // Update the text content if needed, e.g., span.closest('label').textContent = ... fmtVND(currentFee) ...
        }
    });
  }

   // Hi·ªÉn th·ªã/·∫©n th√¥ng tin m√£ ƒë√£ √°p d·ª•ng
   function updateDiscountInfo() {
       const appliedCode = CART?.appliedDiscountCode;
       if (appliedCode && appliedCode.code) { // Check if code exists
           discountInfoDiv.querySelector('.applied-code').textContent = appliedCode.code;
           discountInfoDiv.classList.remove('d-none');
           discountCodeInput.value = appliedCode.code;
           discountCodeInput.readOnly = true;
           btnApplyDiscount.disabled = true;
           discountErrorDiv.classList.add('d-none');
           discountSuccessDiv.classList.add('d-none');
       } else {
           discountInfoDiv.classList.add('d-none');
           // Only clear input if it wasn't readonly (meaning no code was applied)
           if (!discountCodeInput.readOnly) {
               discountCodeInput.value = '';
           }
           discountCodeInput.readOnly = false;
           btnApplyDiscount.disabled = false;
       }
   }


  // ---- Event Listeners ----
  // Hi·ªán/·∫©n th√¥ng tin bank khi ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n
  document.querySelectorAll('.payment-method').forEach(radio => {
    radio.addEventListener('change', (e) => {
      const showBank = (e.target.id === 'payBANK' && e.target.checked);
      document.getElementById('bankInfo').classList.toggle('d-none', !showBank);
    });
  });

  // Thay ƒë·ªïi ph∆∞∆°ng th·ª©c giao h√†ng
  document.querySelectorAll('.ship-method').forEach(radio => {
    radio.addEventListener('change', (e) => {
      if(e.target.checked){
        SHIP_METHOD = e.target.value;
        updateSummary(); // Recalculate totals
      }
    });
  });

   // N√∫t √Åp d·ª•ng m√£ gi·∫£m gi√°
  btnApplyDiscount?.addEventListener('click', async () => { // Added null check
      const code = discountCodeInput.value.trim().toUpperCase();
      if (!code) {
           discountErrorDiv.textContent = 'Vui l√≤ng nh·∫≠p m√£ gi·∫£m gi√°.';
           discountErrorDiv.classList.remove('d-none');
          return;
      }

      discountErrorDiv.classList.add('d-none');
      discountSuccessDiv.classList.add('d-none');
      btnApplyDiscount.disabled = true; // Disable temporarily

      try {
          // **Important:** Ensure the API endpoint matches your CartApiController
          const updatedCart = await fetchJson(`${API_BASE}/apply-discount`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', ...csrfHeaders() },
              body: JSON.stringify({ code: code })
          });
          CART = updatedCart; // Update global CART object
          updateSummary();
          updateDiscountInfo();
           discountSuccessDiv.textContent = `ƒê√£ √°p d·ª•ng m√£ "${code}" th√†nh c√¥ng!`;
           discountSuccessDiv.classList.remove('d-none');
      } catch (err) {
          console.error("L·ªói √°p d·ª•ng m√£:", err);
          discountErrorDiv.textContent = err.message || '√Åp d·ª•ng m√£ th·∫•t b·∫°i.';
          discountErrorDiv.classList.remove('d-none');
          updateDiscountInfo(); // Reset UI if error
      } finally {
          // Re-enable button only if no code is currently applied
          if (!CART?.appliedDiscountCode) {
               btnApplyDiscount.disabled = false;
          }
      }
  });

    // N√∫t X√≥a m√£ gi·∫£m gi√°
  btnRemoveDiscount?.addEventListener('click', async () => { // Added null check
       btnRemoveDiscount.style.pointerEvents = 'none'; // Disable temporarily
       discountErrorDiv.classList.add('d-none');
       discountSuccessDiv.classList.add('d-none');

        try {
          // **Important:** Ensure the API endpoint matches your CartApiController
          const updatedCart = await fetchJson(`${API_BASE}/remove-discount`, {
              method: 'POST', // Or DELETE depending on your API design
              headers: { ...csrfHeaders() }
          });
          CART = updatedCart; // Update global CART object
          updateSummary();
          updateDiscountInfo(); // This will hide the applied code info and enable input/apply button
      } catch (err) {
          console.error("L·ªói x√≥a m√£:", err);
           discountErrorDiv.textContent = err.message || 'X√≥a m√£ th·∫•t b·∫°i.';
           discountErrorDiv.classList.remove('d-none');
      } finally {
          btnRemoveDiscount.style.pointerEvents = 'auto'; // Re-enable button
      }
  });

  // N√∫t x√°c nh·∫≠n ƒë·∫∑t h√†ng
  const btnCheckout = document.getElementById('btnCheckout');
  function setBusy(on){
    if (!btnCheckout) return; // Add null check for safety
    btnCheckout.disabled = on;
    btnCheckout.querySelector('.spinner-border')?.classList.toggle('d-none', !on); // Use optional chaining
    btnCheckout.querySelector('.lbl')?.classList.toggle('d-none', on); // Use optional chaining
    if(on && checkoutErrorDiv) checkoutErrorDiv.classList.add('d-none');
  }

  // X·ª≠ l√Ω click n√∫t "X√°c nh·∫≠n ƒë·∫∑t h√†ng"
  btnCheckout?.addEventListener('click', async ()=>{ // Added null check
    // 1. L·∫•y th√¥ng tin t·ª´ form
    const nameInput = document.getElementById('name');
    const phoneInput = document.getElementById('phone');
    const addressInput = document.getElementById('address');
    const noteInput = document.getElementById('note');

    // Add null checks for form elements
    const name = nameInput?.value.trim() || '';
    const phone = phoneInput?.value.trim() || '';
    const addr = addressInput?.value.trim() || '';
    const note = noteInput?.value.trim() || '';
    const payMethod = document.querySelector('input[name="pay"]:checked')?.value || 'COD';
    // SHIP_METHOD is already updated by its event listener

    // 2. Validate th√¥ng tin c∆° b·∫£n
    if(!name || !phone || !addr){
      alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß H·ªç t√™n, S·ªë ƒëi·ªán tho·∫°i v√† ƒê·ªãa ch·ªâ giao h√†ng.');
      return;
    }
    // (Add phone number, email validation if needed)

    // 3. Chu·∫©n b·ªã request body
    const checkoutRequestData = {
      recipientName: name,
      recipientPhone: phone,
      shippingAddress: addr,
      note: note || null,
      paymentMethod: payMethod,
      shippingMethod: SHIP_METHOD // Use the state variable
      // discountCode: CART?.appliedDiscountCode?.code || null // Include discount code if applied
      // --> Add discountCode field to CheckoutRequest record if supporting it for Buy Now via POST
    };

    let apiUrl = '';
    let requestBody;

    if (IS_BUY_NOW) {
        apiUrl = `${API_BASE}/checkout/buy-now`;
        requestBody = JSON.stringify({
          checkout: checkoutRequestData,
          productId: BUY_NOW_PRODUCT_ID,
          quantity: BUY_NOW_QTY
        });
    } else {
        apiUrl = `${API_BASE}/checkout`;
        requestBody = JSON.stringify(checkoutRequestData);
    }

    // 4. G·ªçi API
    try{
      setBusy(true);

      const response = await fetchJson(apiUrl, {
        method:'POST',
        headers: { 'Content-Type':'application/json', ...csrfHeaders() },
        body: requestBody
      });

      // 5. X·ª≠ l√Ω k·∫øt qu·∫£ tr·∫£ v·ªÅ (CheckoutResponse)
      if (response && response.orderId) { // Check if response and orderId exist
          if (response.paymentMethod === 'VNPAY' && response.paymentUrl) {
              window.location.href = response.paymentUrl; // Redirect to VNPAY
          } else {
              // COD, BANK, or VNPAY error without URL -> Redirect to success page
              window.location.href = ORDER_SUCCESS_URL_BASE + response.orderId;
          }
      } else {
          // Handle cases where API response might be invalid or missing orderId
          console.error("Invalid checkout response:", response);
          throw new Error("ƒê·∫∑t h√†ng kh√¥ng th√†nh c√¥ng. Ph·∫£n h·ªìi t·ª´ m√°y ch·ªß kh√¥ng h·ª£p l·ªá.");
      }

    } catch(err) {
      console.error("L·ªói checkout:", err);
      if(checkoutErrorDiv) {
          // Display the specific error message from fetchJson
          checkoutErrorDiv.textContent = err.message || 'ƒê·∫∑t h√†ng th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i.';
          checkoutErrorDiv.classList.remove('d-none');
      } else {
          alert(err.message || 'ƒê·∫∑t h√†ng th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i.');
      }
    } finally {
      setBusy(false);
    }
  });

  // ---- Initialization ----
  (async function init(){
    try{
      // If not "Buy Now", fetch the real cart via API
      // If "Buy Now", CART is already set via Thymeleaf
      if (!IS_BUY_NOW) {
          // Only fetch if CART is initially null or empty (avoid unnecessary refetch)
          if (!CART || !CART.lines || CART.lines.length === 0) {
              CART = await fetchJson(API_BASE, { headers: csrfHeaders() });
          }
      }
      // Check if CART is still null/invalid after potential fetch
      if (!CART || !CART.lines) {
           throw new Error("Kh√¥ng th·ªÉ t·∫£i th√¥ng tin gi·ªè h√†ng.");
      }

      // Render cart (real or virtual) and update summary
      renderCartLines(CART);
      updateSummary();
      updateDiscountInfo(); // Show applied discount code if exists on page load

    } catch(err) {
        console.error("L·ªói t·∫£i gi·ªè h√†ng:", err);
        if(checkoutErrorDiv) {
            checkoutErrorDiv.textContent = err.message || 'Kh√¥ng t·∫£i ƒë∆∞·ª£c th√¥ng tin gi·ªè h√†ng.';
            checkoutErrorDiv.classList.remove('d-none');
        } else {
             alert(err.message || 'Kh√¥ng t·∫£i ƒë∆∞·ª£c th√¥ng tin gi·ªè h√†ng.');
        }
        // Disable checkout button if cart loading fails
        if(btnCheckout) btnCheckout.classList.add('disabled');
    }
  })();
</script>

<div th:replace="~{fragments/footer :: footer}"></div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>